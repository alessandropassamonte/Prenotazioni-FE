<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-3">
        <i class="bi bi-graph-up"></i> Report Occupazione Postazioni
      </h2>
      
      <!-- Filtri Periodo -->
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            
            <!-- Periodo veloce -->
            <div class="col-md-3">
              <label class="form-label fw-bold">Periodo</label>
              <select 
                class="form-select" 
                [(ngModel)]="quickPeriod" 
                (change)="onQuickPeriodChange()">
                <option value="today">Oggi</option>
                <option value="week">Settimana Corrente</option>
                <option value="month">Mese Corrente</option>
                <option value="custom">Personalizzato</option>
              </select>
            </div>

            <!-- Data inizio (solo se custom) -->
            <div class="col-md-3" *ngIf="quickPeriod === 'custom'">
              <label class="form-label fw-bold">Data Inizio</label>
              <input 
                type="date" 
                class="form-control" 
                [(ngModel)]="startDate">
            </div>

            <!-- Data fine (solo se custom) -->
            <div class="col-md-3" *ngIf="quickPeriod === 'custom'">
              <label class="form-label fw-bold">Data Fine</label>
              <input 
                type="date" 
                class="form-control" 
                [(ngModel)]="endDate">
            </div>

            <!-- Pulsanti -->
            <div class="col-md-3">
              <button 
                class="btn btn-primary me-2" 
                (click)="applyCustomFilter()"
                *ngIf="quickPeriod === 'custom'">
                <i class="bi bi-search"></i> Cerca
              </button>
              <button 
                class="btn btn-success" 
                (click)="exportToCSV()"
                *ngIf="statistics">
                <i class="bi bi-download"></i> Esporta CSV
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Caricamento...</span>
    </div>
    <p class="mt-3">Caricamento statistiche in corso...</p>
  </div>

  <!-- Errore -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- Contenuto Report -->
  <div *ngIf="!loading && !error && statistics">
    
    <!-- KPI Cards -->
    <div class="row mb-4">
      <!-- Media Occupazione -->
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-primary h-100">
          <div class="card-body text-center">
            <i class="bi bi-percent fs-1 text-primary"></i>
            <h5 class="card-title mt-2">Occupazione Media</h5>
            <h2 class="text-primary mb-0">{{ statistics.averageOccupancyRate }}%</h2>
            <p class="text-muted small mb-0">su {{ statistics.totalWorkingDays }} giorni lavorativi</p>
          </div>
        </div>
      </div>

      <!-- Postazioni Medie Occupate -->
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-success h-100">
          <div class="card-body text-center">
            <i class="bi bi-people-fill fs-1 text-success"></i>
            <h5 class="card-title mt-2">Media Occupate</h5>
            <h2 class="text-success mb-0">{{ statistics.averageOccupiedDesks }}</h2>
            <p class="text-muted small mb-0">su {{ statistics.totalDesks }} totali</p>
          </div>
        </div>
      </div>

      <!-- Postazioni Medie Libere -->
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-info h-100">
          <div class="card-body text-center">
            <i class="bi bi-inbox fs-1 text-info"></i>
            <h5 class="card-title mt-2">Media Libere</h5>
            <h2 class="text-info mb-0">{{ statistics.averageFreeDesks }}</h2>
            <p class="text-muted small mb-0">disponibili al giorno</p>
          </div>
        </div>
      </div>

      <!-- Periodo -->
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-secondary h-100">
          <div class="card-body text-center">
            <i class="bi bi-calendar-range fs-1 text-secondary"></i>
            <h5 class="card-title mt-2">Periodo Analizzato</h5>
            <p class="mb-1">
              <strong>Dal:</strong> {{ statistics.startDate | date:'dd/MM/yyyy' }}<br>
              <strong>Al:</strong> {{ statistics.endDate | date:'dd/MM/yyyy' }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Picchi e Minimi -->
    <div class="row mb-4" *ngIf="statistics.mostOccupiedDay && statistics.leastOccupiedDay">
      <div class="col-md-6 mb-3">
        <div class="card shadow-sm border-danger h-100">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-arrow-up-circle-fill text-danger"></i> 
              Giorno con Maggiore Occupazione
            </h5>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="mb-0">{{ statistics.mostOccupiedDay.date | date:'dd/MM/yyyy' }}</h4>
                <p class="text-muted mb-0">{{ statistics.mostOccupiedDay.dayOfWeek }}</p>
              </div>
              <div class="text-end">
                <h3 class="text-danger mb-0">{{ statistics.mostOccupiedDay.occupancyRate }}%</h3>
                <p class="mb-0">
                  <span class="badge bg-danger">
                    {{ statistics.mostOccupiedDay.occupiedDesks }} occupate
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6 mb-3">
        <div class="card shadow-sm border-success h-100">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-arrow-down-circle-fill text-success"></i> 
              Giorno con Minore Occupazione
            </h5>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="mb-0">{{ statistics.leastOccupiedDay.date | date:'dd/MM/yyyy' }}</h4>
                <p class="text-muted mb-0">{{ statistics.leastOccupiedDay.dayOfWeek }}</p>
              </div>
              <div class="text-end">
                <h3 class="text-success mb-0">{{ statistics.leastOccupiedDay.occupancyRate }}%</h3>
                <p class="mb-0">
                  <span class="badge bg-success">
                    {{ statistics.leastOccupiedDay.freeDesks }} libere
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grafici -->
    <div class="row mb-4">
      <!-- Grafico Occupazione Giornaliera -->
      <div class="col-lg-8 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div style="height: 400px;">
              <canvas id="dailyOccupancyChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Grafico Confronto Piani -->
      <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div style="height: 400px;">
              <canvas id="floorComparisonChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grafico Trend -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <div style="height: 300px;">
              <canvas id="occupancyTrendChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabella Dettaglio per Piano -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="bi bi-building"></i> Statistiche per Piano
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Piano</th>
                    <th class="text-center">Totale Postazioni</th>
                    <th class="text-center">Totale Prenotazioni</th>
                    <th class="text-center">Occupazione Media</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let floor of statistics.floorStatistics">
                    <td>
                      <strong>{{ floor.floorName }}</strong>
                      <br>
                      <small class="text-muted">Piano {{ floor.floorNumber }}</small>
                    </td>
                    <td class="text-center">{{ floor.totalDesks }}</td>
                    <td class="text-center">
                      <span class="badge bg-info">{{ floor.totalBookings }}</span>
                    </td>
                    <td class="text-center">
                      <div class="progress" style="height: 25px;">
                        <div 
                          class="progress-bar" 
                          [class.bg-danger]="floor.averageOccupancyRate > 80"
                          [class.bg-warning]="floor.averageOccupancyRate > 60 && floor.averageOccupancyRate <= 80"
                          [class.bg-success]="floor.averageOccupancyRate <= 60"
                          role="progressbar" 
                          [style.width.%]="floor.averageOccupancyRate">
                          {{ floor.averageOccupancyRate }}%
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabella Dettaglio Giornaliero (Solo primi 10 giorni per evitare overflow) -->
    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">
              <i class="bi bi-calendar3"></i> Dettaglio Giornaliero
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Giorno</th>
                    <th class="text-center">Occupate</th>
                    <th class="text-center">Libere</th>
                    <th class="text-center">Tasso</th>
                    <th>Note</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let day of statistics.dailyOccupancy" 
                      [class.table-warning]="day.isHoliday">
                    <td>{{ day.date | date:'dd/MM/yyyy' }}</td>
                    <td>{{ day.dayOfWeek }}</td>
                    <td class="text-center">
                      <span class="badge bg-primary">{{ day.occupiedDesks }}</span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-success">{{ day.freeDesks }}</span>
                    </td>
                    <td class="text-center">
                      <strong>{{ day.occupancyRate }}%</strong>
                    </td>
                    <td>
                      <span *ngIf="day.isHoliday" class="badge bg-warning text-dark">
                        <i class="bi bi-calendar-x"></i> 
                        {{ day.holidayName || 'Weekend' }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
